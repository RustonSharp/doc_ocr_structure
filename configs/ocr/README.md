# OCR 自定义字典配置说明

## 概述

自定义字典功能用于提升 OCR 识别准确率，特别是对于专业术语、行业特定词汇和特殊符号的识别。

## 文件说明

### 1. `custom_words.txt` - 自定义词汇表

**用途**：添加专业术语、行业词汇、特殊符号等，帮助 Tesseract 更准确地识别这些词汇。

**格式**：
- 每行一个词汇
- 支持中文、英文、数字、特殊符号
- 以 `#` 开头的行为注释，会被忽略
- 空行会被忽略

**示例**：
```
增值税专用发票
发票号码
纳税人识别号
```

**使用场景**：
- 发票识别：添加发票相关术语
- 合同识别：添加合同相关术语
- 证件识别：添加证件相关术语
- 行业术语：添加特定行业的专业词汇

### 2. `custom_patterns.txt` - 自定义模式文件

**用途**：定义特定格式的文本模式（正则表达式），帮助 OCR 识别特定格式的文本。

**格式**：
- 每行一个正则表达式模式
- 以 `#` 开头的行为注释，会被忽略
- 空行会被忽略

**示例**：
```
# 发票号码模式
\d{8,12}

# 日期模式
\d{4}-\d{2}-\d{2}

# 金额模式
￥[\d,]+\.?\d*
```

**使用场景**：
- 识别特定格式的编号（如发票号、合同号）
- 识别日期格式
- 识别金额格式
- 识别证件号码格式

## 配置方法

### 1. 在 `configs/ocr.json` 中配置路径

```json
{
  "ocr_engines": {
    "engines": {
      "pytesseract": {
        "custom_words_path": "configs/ocr/custom_words.txt",
        "custom_patterns_path": "configs/ocr/custom_patterns.txt"
      }
    }
  }
}
```

### 2. 动态指定字典路径（通过 API）

在调用 OCR 时，可以通过 `dictionary_path` 参数动态指定字典文件：

```python
result = await ocr_engine.process_image_with_current_engine(
    image_data,
    dictionary_path="path/to/custom_dictionary.txt"
)
```

## 使用建议

### 1. 词汇表优化

- **添加高频专业术语**：将文档中经常出现的专业术语添加到词汇表
- **区分大小写**：如果需要区分大小写，确保词汇表中有正确的大小写形式
- **避免重复**：同一个词汇不要重复添加
- **定期更新**：根据实际识别效果，不断优化词汇表

### 2. 模式文件优化

- **精确匹配**：模式应该尽可能精确，避免误匹配
- **测试验证**：添加新模式后，建议用实际文档测试验证
- **性能考虑**：过于复杂的正则表达式可能影响识别性能

### 3. 针对不同场景的配置

#### 发票识别
- 添加发票相关术语（发票代码、发票号码、开票日期等）
- 添加财务相关术语（金额、税额、价税合计等）
- 添加日期和金额格式模式

#### 合同识别
- 添加合同相关术语（合同编号、甲方、乙方等）
- 添加法律相关术语
- 添加日期格式模式

#### 证件识别
- 添加证件相关术语（身份证号、统一社会信用代码等）
- 添加证件号码格式模式

## Google Cloud Vision 支持

**重要**：Google Cloud Vision API **不支持直接的自定义字典功能**，但项目提供了**后处理校正**功能作为替代方案。

### 后处理校正功能

对于 Google Cloud Vision 引擎，可以使用后处理校正来校正专业术语：

1. **启用后处理**：在 `configs/ocr.json` 中设置 `enable_post_process: true`
2. **配置词汇表**：设置 `custom_words_path` 指向自定义词汇表文件
3. **自动校正**：OCR 识别结果会自动经过后处理校正

详细说明请参考：[Google Cloud Vision 后处理校正文档](GOOGLE_VISION_POST_PROCESS.md)

### 对比

| 特性 | Tesseract 自定义字典 | Google Vision 后处理 |
|------|---------------------|---------------------|
| **实现方式** | OCR 识别时使用 | OCR 识别后校正 |
| **准确性** | 识别阶段优化，更准确 | 后处理校正，依赖初始识别 |
| **性能** | 可能略微影响识别速度 | 几乎不影响性能 |

## 注意事项

1. **pytesseract 支持**：自定义字典功能（`--user-words` 和 `--user-patterns`）仅支持 `pytesseract` 引擎。
2. **Google Cloud Vision**：不支持直接自定义字典，但可以使用后处理校正功能（见上方说明）。

2. **文件路径**：确保配置的路径正确，文件存在且可读。

3. **文件编码**：建议使用 UTF-8 编码保存文件，特别是包含中文时。

4. **性能影响**：过大的词汇表可能影响识别速度，建议控制在合理范围内（通常几百到几千个词汇）。

5. **重新训练**：对于大量自定义词汇，可能需要重新训练 Tesseract 模型以获得最佳效果（高级用法）。

## 验证方法

1. **对比测试**：使用相同图片，分别测试有无自定义字典的识别效果
2. **准确率统计**：统计特定术语的识别准确率提升情况
3. **错误分析**：分析识别错误，针对性优化字典内容

## 示例：添加发票识别专用字典

1. 编辑 `configs/ocr/custom_words.txt`，添加发票相关术语
2. 编辑 `configs/ocr/custom_patterns.txt`，添加发票号码、日期等格式模式
3. 确保 `configs/ocr.json` 中配置了正确的路径
4. 重启服务或重新加载配置
5. 使用发票图片测试识别效果

## 故障排查

1. **字典未生效**：
   - 检查文件路径是否正确
   - 检查文件是否存在且可读
   - 检查文件编码是否为 UTF-8
   - 查看日志确认字典文件是否被加载

2. **识别效果不佳**：
   - 检查词汇是否正确拼写
   - 检查模式是否正确（可以使用在线正则表达式测试工具验证）
   - 考虑增加更多相关词汇
   - 检查图片质量是否足够清晰

3. **性能问题**：
   - 检查词汇表是否过大
   - 考虑精简词汇表，只保留最常用的词汇
   - 检查模式文件中的正则表达式是否过于复杂

